{% extends 'base.html' %}

{% block title %}Upload Files - CloudVault{% endblock %}

{% block extra_css %}
<style>
    #dragDropArea {
        border: 2px dashed #cbd5e1;
        transition: all 0.3s ease;
    }
    
    #dragDropArea.highlight {
        border-color: #6366f1;
        background-color: rgba(99, 102, 241, 0.05);
    }
    
    .progress-bar {
        width: 0%;
        height: 4px;
        background-color: #6366f1;
        transition: width 0.3s ease;
    }
    
    /* Ensure consistent form field heights */
    .form-input {
        height: 42px;
    }
    
    select.form-input {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
    }
    
    textarea.form-input {
        min-height: 84px;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-gray-100 min-h-[80vh] py-10">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 fade-in">Upload Files</h1>
                <p class="mt-1 text-sm text-gray-500 fade-in">Add files to your CloudVault storage</p>
            </div>
            {% if current_folder %}
            <a href="{% url 'files:file_list' %}?folder={{ current_folder.id }}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to {{ current_folder.name }}
            </a>
            {% else %}
            <a href="{% url 'files:file_list' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Files
            </a>
            {% endif %}
        </div>
        
        <!-- Folder Location Indicator -->
        {% if current_folder %}
        <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-6 fade-in">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-folder text-yellow-500"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-yellow-800">Uploading to folder: {{ current_folder.name }}</h3>
                    <div class="mt-2 text-sm text-yellow-700">
                        <p>Files will be stored in this folder</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="bg-white shadow rounded-lg overflow-hidden fade-in">
            <div class="p-6">
                <form method="post" enctype="multipart/form-data" id="uploadForm">
                    {% csrf_token %}
                    
                    {% if current_folder %}
                    <input type="hidden" name="folder" value="{{ current_folder.id }}">
                    {% endif %}
                    
                    {% if form.errors %}
                    <div class="mb-6 bg-red-50 text-red-700 p-4 rounded-md">
                        <p class="font-medium">Please correct the following errors:</p>
                        <ul class="list-disc pl-5 mt-2 text-sm">
                            {% for field in form %}
                                {% for error in field.errors %}
                                    <li>{{ field.label }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <!-- Drag and Drop Area -->
                    <div id="dragDropArea" class="p-10 text-center rounded-lg mb-6 cursor-pointer">
                        <div id="defaultUploadUI">
                            <i class="fas fa-cloud-upload-alt text-5xl text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Drag files here to upload</h3>
                            <p class="text-sm text-gray-500 mb-4">or click to browse your files</p>
                            <button type="button" id="browseButton" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                <i class="fas fa-folder-open mr-2"></i>
                                Browse Files
                            </button>
                            <input type="file" id="fileInput" name="file" class="hidden" required>
                        </div>
                        
                        <div id="uploadProgressUI" class="hidden">
                            <div class="mb-4">
                                <i class="fas fa-file text-3xl text-primary-500"></i>
                            </div>
                            <p id="fileName" class="text-gray-800 font-medium mb-2">file.jpg</p>
                            <div class="w-full bg-gray-200 rounded-full h-1 mb-2">
                                <div class="progress-bar rounded-full"></div>
                            </div>
                            <p id="fileSize" class="text-sm text-gray-500">0 KB</p>
                        </div>
                    </div>
                    
                    <!-- File Details -->
                    <div class="space-y-6">
                        <div>
                            <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-tag mr-2"></i>
                                File Title <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="title" id="{{ form.title.id_for_label }}" required
                                   class="mt-1 focus:ring-primary-500 focus:border-primary-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md form-input">
                        </div>
                        
                        <div>
                            <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-align-left mr-2"></i>
                                Description
                            </label>
                            <textarea name="description" id="{{ form.description.id_for_label }}" rows="3" 
                                      class="mt-1 focus:ring-primary-500 focus:border-primary-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md form-input"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.category.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                    <i class="fas fa-tag mr-2"></i>
                                    Category
                                </label>
                                <select name="category" id="{{ form.category.id_for_label }}" 
                                        class="mt-1 focus:ring-primary-500 focus:border-primary-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md form-input">
                                    <option value="">Select a category</option>
                                    {% for category in form.category.field.queryset %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            {% if not current_folder %}
                            <div>
                                <label for="folder" class="block text-sm font-medium text-gray-700 mb-1">
                                    <i class="fas fa-folder mr-2"></i>
                                    Folder
                                </label>
                                <select name="folder" id="folder" 
                                        class="mt-1 focus:ring-primary-500 focus:border-primary-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md form-input">
                                    <option value="">Root Directory</option>
                                    {% for folder in request.user.folders.all %}
                                    <option value="{{ folder.id }}">{{ folder.get_path }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="flex items-start">
                            <div class="flex items-center h-5">
                                <input id="{{ form.is_public.id_for_label }}" name="is_public" type="checkbox" 
                                       class="focus:ring-primary-500 h-4 w-4 text-primary-600 border-gray-300 rounded">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="{{ form.is_public.id_for_label }}" class="font-medium text-gray-700">Make file public</label>
                                <p class="text-gray-500">Public files can be accessed by anyone with the link</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 flex items-center justify-end">
                        {% if current_folder %}
                        <a href="{% url 'files:file_list' %}?folder={{ current_folder.id }}" class="text-sm font-medium text-gray-700 hover:text-gray-500 mr-4">
                            Cancel
                        </a>
                        {% else %}
                        <a href="{% url 'files:file_list' %}" class="text-sm font-medium text-gray-700 hover:text-gray-500 mr-4">
                            Cancel
                        </a>
                        {% endif %}
                        <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            <i class="fas fa-upload mr-2"></i>
                            Upload File
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="mt-6 bg-white shadow rounded-lg p-6 fade-in">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Storage Information</h3>
            <div class="flex items-center">
                <div class="w-full max-w-xs">
                    <div class="relative pt-1">
                        <div class="overflow-hidden h-2 text-xs flex rounded bg-gray-200">
                            <div style="width: {{ user.profile.get_storage_usage_percentage }}%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center {% if user.profile.get_storage_usage_percentage > 90 %}bg-red-500{% elif user.profile.get_storage_usage_percentage > 70 %}bg-yellow-500{% else %}bg-primary-500{% endif %}"></div>
                        </div>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-600">{{ user.profile.get_readable_storage_used }} used of {{ user.profile.get_readable_storage_limit }}</p>
                    <p class="text-xs text-gray-500 mt-1">{{ user.profile.get_storage_usage_percentage }}% used</p>
                </div>
            </div>
            <div class="mt-2">
                <p class="text-sm text-gray-600">Available: {{ user.profile.get_available_storage_readable }}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dragDropArea = document.getElementById('dragDropArea');
        const fileInput = document.getElementById('fileInput');
        const browseButton = document.getElementById('browseButton');
        const defaultUploadUI = document.getElementById('defaultUploadUI');
        const uploadProgressUI = document.getElementById('uploadProgressUI');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const progressBar = document.querySelector('.progress-bar');
        
        // Click on browse button
        browseButton.addEventListener('click', function() {
            fileInput.click();
        });
        
        // Click on drag area
        dragDropArea.addEventListener('click', function(e) {
            if (e.target !== browseButton && !browseButton.contains(e.target)) {
                fileInput.click();
            }
        });
        
        // File selected
        fileInput.addEventListener('change', function() {
            handleFiles(this.files);
        });
        
        // Drag and drop events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dragDropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dragDropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dragDropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dragDropArea.classList.add('highlight');
        }
        
        function unhighlight() {
            dragDropArea.classList.remove('highlight');
        }
        
        // Handle dropped files
        dragDropArea.addEventListener('drop', function(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        });
        
        // Process the files
        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                
                // Update UI
                defaultUploadUI.classList.add('hidden');
                uploadProgressUI.classList.remove('hidden');
                
                // Show file details
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                
                // Simulate upload progress
                simulateUpload();
                
                // Auto-fill title from filename
                const titleInput = document.querySelector('input[name="title"]');
                if (!titleInput.value) {
                    // Remove extension from filename
                    const nameWithoutExt = file.name.replace(/\.[^/.]+$/, "");
                    // Format name (capitalize first letter of each word)
                    const formattedName = nameWithoutExt
                        .replace(/[-_]/g, ' ')
                        .replace(/\w\S*/g, function(txt) {
                            return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                        });
                    titleInput.value = formattedName;
                }
            }
        }
        
        // Simulate upload progress
        function simulateUpload() {
            let width = 0;
            const interval = setInterval(function() {
                if (width >= 100) {
                    clearInterval(interval);
                } else {
                    width += 5;
                    progressBar.style.width = width + '%';
                }
            }, 100);
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    });
</script>
{% endblock %} 